<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/index.css"/>
	</head>
	<body oncontextmenu="return false;">
		<div class="box_top">
			<ul class="box_ul">
				<li class="top_items fl">Test：<span id="testName"></span></li>
				<li class="top_items fl">App：<span id="appName"></span></li>
				<!-- <li class="top_items fl">last modify by chujun years ago</li> -->
				<li class="top_items fr">
					<a href="javascript:void(0)" onclick = "saveSteps()" class="a-block">Save&Exit</a>
				</li>
				<li class="top_items fr">
					<a id="startConnection" href="javascript:void(0)" onclick="startConnection();" class="a-block">启动</a>
				</li>
			</ul>
		</div>

		<div class="cont_left fl">
			<ul id="box_step" class='ul_box box_left fl'>
				<li class="items">Reset App</li>
			</ul>
			<form id="stepForm" class="fl">
				<input id="testCaseId" name="testCaseId" type="hidden" value="" />
				<input id="tm_hidden_id" name="id" type="hidden" value="" />
				<ul id="updateStep" class="ul_box box_left">
					<li class="items">
						<a href="javascript:void(0)" class="a-block">Enable</a><a href="javascript:void(0)" onclick="option.cancle()" class="a-block down_menu">X</a>
					</li>
					<li class="items">
						<p class="items_box">Step</p>
						<p id="step_content" class="items_box">Launch the app</p>
						<p class="items_box">Comments</p>
						<p class="items_box"><a id="comment_content" href="javascript:void(0)" class="link_text"></a></p>
					</li>
					<li class="items">
						<p class="items_box">Type</p>
						<p class="items_box"><a href="javascript:void(0)" class="link_text">Action</a></p>
					</li>
					<li class="items">
						<p class="items_box">Element</p>
						<p class="items_box"><a id="klass_content" href="javascript:void(0)" class="link_text"></a></p>
						<p id="xpath_content" class="items_box"></p>
						<p class="items_box">Action</p>
						<p class="items_box"><a id="action_content" href="javascript:void(0)" class="link_text">Click</a></p>
					</li>
					<li class="items">
						<p class="items_box">On Failure Behaviour</p>
						<p class="items_box"><a href="javascript:void(0)" class="link_text">Fail Test</a></p>
						<p class="items_box">Take Screenshot</p>
						<p class="items_box"><a href="javascript:void(0)" class="link_text">Failure</a></p>
					</li>
					<li class="items">
						<p class="items_box">Step Pause</p>
						<p class="items_box"><a href="javascript:void(0)" class="link_text">Pause for 1000ms after executing step</a></p>
						<p class="items_box">Step Timeout</p>
						<p class="items_box"><a id="time_content" href="javascript:void(0)" class="link_text">0ms</a></p>
						<p class="items_box">Step Repeats</p>
						<p class="items_box"><a id="repeat_content" href="javascript:void(0)" class="link_text">1</a></p>
					</li>
					<li class="items">
						<p class="btn-box">
							<a id="tm_btn_update" href="javascript:void(0)" onclick="option.update()" class="btn">修改</a>
							<a id="tm_btn_save" href="javascript:void(0)" onclick="option.save()" class="btn">保存</a>
							<a href="javascript:void(0)" onclick="option.cancle()" class="btn">取消</a>
						</p>
					</li>
				</ul>
			</form>
		</div>
		
		<div id="box_canvas" class="box_image fl">
			<canvas id="canvas"></canvas>
			<canvas id="myCanvas" tabIndex=-1></canvas>
			<div id="tipbox">
				<div id="arrow" class="fl"></div>
				<div id="info" class="fl">
					<p>xpath...</p>
					<p><a href="javascript:void(0)" onclick="keyInput.dialog()">键盘输入</a></p>
				</div>
			</div>
			<div class="clear"></div>
		</div>
		<!--contextMenu-->
		<div class="contextMenu">
			<ul>
				<!--<li>
					<a href="javascript:void(0);" onclick="option.updateStep();"><span class="fa fa-camera-retro"></span>修改</a>
				</li>-->
				<li>
					<a href="javascript:void(0);" onclick="option.remove();"><span class="fa fa-twitter"></span>删除</a>
				</li>
			</ul>
		</div>
		<!--键盘输入  start-->
		<div id="LoginBox">
		  <div class="row">
		      <span class="inputBox">
		          <input type="text" class="inpt" id="message" placeholder="键盘输入文本信息" autofocus="autofocus"/>
		      </span>
		  </div>
		  <div class="row">
		      <input id="loginbtn" type="button" onclick="keyInput.commitInput()" class="submit_btn" value="确定" />
		      <input id="loginbtn" type="button" onclick="keyInput.cancle()" class="submit_btn" value="取消" />
		    </div>
		</div>
		<!--键盘输入  end-->
		
		<!-- 单击shift键盘事件 start-->
		<div id="dg_box_menu">
		  	<ul class="ul_box_menu ul_box box_right fl">
				<li class="items box_m_items">
					<a href="javascript:void(0)" class="a-block">X111</a>
				</li>
				<li class="items box_m_items">
					<a href="javascript:void(0)" class="a-block">X222</a>
				</li>
				<li class="items box_m_items">
					<a href="javascript:void(0)" class="a-block">X333</a>
				</li>
				<li class="items box_m_items">
					<a href="javascript:void(0)" class="a-block">X444</a>
				</li>
				<li class="items box_m_items">
					<a href="javascript:void(0)" class="a-block">X555</a>
				</li>
			</ul>
			<ul id="box_menu" class="ul_box_menu ul_box fl">
				<li class="items">
					<a href="javascript:void(0)" class="a-block">X111</a>
				</li>
				<li class="items">
					<a href="javascript:void(0)" class="a-block">X222</a>
				</li>
				<li class="items">
					<a href="javascript:void(0)" class="a-block">X333</a>
				</li>
				<li class="items">
					<a href="javascript:void(0)" class="a-block">X444</a>
				</li>
				<li class="items">
					<a href="javascript:void(0)" class="a-block">X555</a>
				</li>
			</ul>
		</div>
		<!-- 单击shift键盘事件  end -->
		<script src="http://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>
		<script src="socket.io.js"></script>
		<script>
			var caseId = getQueryString("caseId");
			var staticPath = "http://125.76.215.206:8089/SAPlatform";
			$(function(){
				$("#appName").html(getQueryString("appName"));
				$("#testName").html(getQueryString("testName"));
				$.ajax({
					type:"post",
					url:staticPath + "/step/loadSteps",
					data:{"testCaseId":caseId},
					success:function(data){
						//console.log(JSON.stringify(data));
						var html = "";
						for(var i=0;i<data.length;i++){
							html += '<li class="items" value="'+data[i].indeks+'"><a href="javascript:void(0)" onclick="option.stepInfo('+data[i].testCaseId+','+data[i].indeks+')" class="a-block">'+data[i].indeks+" "+data[i].action+'</a><a href="javascript:void(0)" onclick="shouMenu(this,'+data[i].testCaseId+','+data[i].indeks+','+data[i].id+')" class="a-block down_menu">+</a></li>';
						}
						$("#box_step").append(html);
					}
				});
			});
			/**获取场景用例参数*/
			function getQueryString(name) {
		      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
		      var r = window.location.search.substr(1).match(reg);
		      if (r != null) return unescape(r[2]); return null;
			}
			console.log("caseId="+caseId+",appName="+getQueryString("appName")+",testName="+getQueryString("testName"));
			/*key input*/
			var keyInput = {
				dialog:function(){
					$("#mask").remove();
					$("body").append("<div id='mask'></div>");
					$("#mask").addClass("mask").fadeIn("slow");
					$("#LoginBox").fadeIn("slow");
				},
				commitInput:function(){
					wsss.send("input:"+$("#message").val()+",x:"+$("#tipbox").data("x")+",y:"+$("#tipbox").data("y"));
					keyInput.cancle();
				},
				cancle:function(){
					$("#LoginBox").fadeOut("fast");
					$("#mask").css({ display: 'none' });
				}
			}
			
			/*修改步骤信息*/
			var option = {
				stepInfo:function(caseId,indeks){
					$("#updateStep").css("display","block");
					$("#tm_btn_update").css({"display":"inline-block","line-height":"22px"});
					$("#tm_btn_save").css("display","none");
					$.ajax({
						type:"post",
						url:staticPath + "/step/loadSteps",
						data:{testCaseId:caseId,indeks:indeks},
						success:function(data){
							console.log(JSON.stringify(data));
							$("#testCaseId").val(data[0].testCaseId);
							$("#tm_hidden_id").val(data[0].id);
							$("#step_content").html(data[0].action + " " + data[0].klass);
							$("#comment_content").html('');//data[0].comments
							$("#xpath_content").html(data[0].xpath);
							$("#klass_content").html(data[0].klass);
							$("#action_content").html(data[0].action);
							$("#time_content").html(data[0].responseTime);
							$("#tm_btn_save").attr("data-caseid",caseId);
							$("#tm_btn_save").attr("data-indeks",indeks);
							//$("#repeat_content").html(data[0].responseTime);
						}
					});
				},
				cancle:function(){
					$("#updateStep").css("display","none");
				},
				save:function(){
					var caseId = $("#tm_btn_save").attr("caseid");
					var indeks = $("#tm_btn_save").data("indeks");
					//这里写更新业务功能  应该是需要调用更新api
					console.log("##########"+$("#stepForm").serialize());
					$.ajax({
						type:"post",
						url:staticPath + "/step/updateStepById",
						data:$("#stepForm").serialize(),
						success:function(data){
							if(data=="success"){
								window.location.reload();
								option.stepInfo(caseId,indeks);
							}
						}
					})
				},
				update:function(){
					$("#tm_btn_save").css({"display":"inline-block","line-height":"22px"});
					$("#tm_btn_update").css("display","none");
					$("#step_content").html('<input name="step" class="edit_input" value="'+$("#step_content").html()+'" type="text"/>');
					$("#comment_content").html('<input name="comments" class="edit_input" value="'+$("#comment_content").html()+'" type="text"/>');
					$("#xpath_content").html('<input name="xpath" class="edit_input" value="'+$("#xpath_content").html()+'" type="text"/>');
					$("#klass_content").html('<input name="klass" class="edit_input" value="'+$("#klass_content").html()+'" type="text"/>');
					$("#action_content").html('<input name="action" class="edit_input" value="'+$("#action_content").html()+'" type="text"/>');
					$("#time_content").html('<input name="responseTime" class="edit_input" value="'+$("#time_content").html()+'" type="text"/>');
				},
				remove:function(){
					var id = $(".contextMenu").data("id");
					$.ajax({
						type:"post",
						url:staticPath + "/step/deleteStepById",
						data:{id:id},
						success:function(data){
							if(data=="success"){
								window.location.reload();
							}
						}
					})
				},
				updateStep:function(){
					option.stepInfo($(".contextMenu").data("caseid"),$(".contextMenu").data("indeks"));
					option.update();
				}
			}
			/**菜单功能**/
			$(".box_m_items").hover(function() {
				$("#box_menu").css("display", "block");
				$("#box_menu").hover(function() {
					$("#box_menu").css("display", "block");
				}, function() {
					$("#box_menu").css("display", "none");
				});
			}, function() {
				$("#box_menu").css("display", "none");
			});


			/*jshint browser:true*/
			var BLANK_IMG ='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='

			var canvas = document.getElementById('canvas'),
				g = canvas.getContext('2d')
			var mainWidth = 0;
			var mainHeight = 0;

			var ws = new WebSocket('ws://localhost:9002', 'minicap')
			ws.binaryType = 'blob'

			ws.onclose = function() {
				console.log('onclose', arguments)
			}

			ws.onerror = function() {
				console.log('onerror', arguments)
			}

			ws.onmessage = function(message) {
				var blob = new Blob([message.data], {
					type: 'image/jpeg'
				})
				var URL = window.URL || window.webkitURL
				var img = new Image()
				img.onload = function() {
					console.log(img.width, img.height)
					canvas.width = img.width
					canvas.height = img.height
					g.drawImage(img, 0, 0)
					img.onload = null
					img.src = BLANK_IMG
					img = null
					u = null
					blob = null
				}
				var u = URL.createObjectURL(blob)
				img.src = u
			}

			function setWidthHeight(width, height) {
				mainWidth = width;
				mainHeight = height;
			}

			ws.onopen = function() {
				console.log('onopen', arguments)
				ws.send('1920x1080/0')
			}

			/**利用websocket通信去发信息到node**/
			var wss = new WebSocket('ws://localhost:9003');

			wss.onopen = function(e) {
				console.log("连接服务器成功");
			}
			wss.onclose = function(e) {
				console.log("服务器关闭");
			}
			wss.onerror = function() {
				console.log("连接出错");
			}

			/*展示控件信息*/
			var wsss = new WebSocket("ws://127.0.0.1:16488");
			var result = document.querySelector('#result');

			wsss.onopen = function() {
				result.innerHTML = '已连接上！';
				console.log('已连接上！');
			}
			// 下面可以改成鼠标的监听器，然后将鼠标的事件一个发送个agent，另一个使用展示控件的js代码
			/*
			document.querySelector('form').onsubmit = function(e) {
			  var msg = document.querySelector('#m').value;
			  wsss.send(msg);
			  return false;
			}
			*/
			function startConnection() {
				wsss.send("start");
				$("#startConnection").html("暂停");
			}
			var jsonStr = "";
			wsss.onmessage = function(e) {
				// alert(e.data);
				if(e.data.startsWith("data:")) {
					str = e.data.replace("data:", "");
					setJsonStr(str);
					// map = JSON.parse(str);
				}
			}
			wsss.onclose = function() {
				console.log('连接已关闭！');
			}

			var myCanvas = document.getElementById("myCanvas");
			// var myCanvas = document.getElementById("canvas");
			myCanvas.width = 360;
			myCanvas.height = 640;
			var context = myCanvas.getContext("2d");
			context.fillStyle = 'rgba(255, 255, 255, 0)';
			context.lineWidth = "2";

			document.getElementById("myCanvas").onmousemove = function(e) {
				var arrs = mouseMove(e);
				drawBorder(arrs);
			};

			function setJsonStr(json) {
				jsonStr = json;
			}

			function mouseMove(event) {
				var left, top;
				var sign = $('#myCanvas');
				top1 = sign.offset().top;
				// console.log(top1)
				left = sign.offset().left;
				// console.log(left)

				var x = event.clientX - parseInt(left);
				var y = event.clientY - parseInt(top1);
				return [x, y];
			}

			function drawBorder(arrs) {
				if(jsonStr) {
					jsons = jsonStr;
					var maps = JSON.parse(jsons);
					context.clearRect(0, 0, 1080 / 3, 1808 / 3);
					// console.log(maps);
					if(maps[0]) {
						// drawBorder_1(arrs, maps);
					}
				}
			}

			var widget_json = "";
			var step_list = [];

			function drawBorder_1(arrs, map) {
				var widget = drawBorder_1_getWidget(arrs,map);
				var arr = map[prop]["bounds"];
				context.strokeRect(arr[0] / 3, arr[1] / 3, (arr[2] - arr[0]) / 3, (arr[3] - arr[1]) / 3);
				widget_json = JSON.stringify(map[prop]);
				showTipBox(arr);
			}
			
			
			function drawBorder_1_getWidget(arrs,map){
				var deep = 0;
				var widget = null;
				
				
				for(var prop in map){
					var arr = map[prop]["bounds"];
					if (arrs[0] >= arr[0] / 3 && arrs[1] >= arr[1] / 3 && arrs[0] < arr[2] / 3 && arrs[1] < arr[3] / 3) {
						var info = drawBorder_2_getWidget(arrs,map[prop]["childMap"],deep);
						
						if(info["deep"]>deep){
							widget = info["widget"];
						}
					}
				}
				console.log(widget);
				return widget;
			}
			function drawBorder_2_getWidget(arrs,map){
				var deep = 0;
				var temInfo = {};
				
			}
			
			function drawBorder_2_getWidget(arrs,map,deep){
				var flag = false;
				if(map==null){
					return {"deep":deep,"widget":map};
				}
				for(var prop in map){
					var arr = map[prop]["bounds"];
					if (arrs[0] >= arr[0] / 3 && arrs[1] >= arr[1] / 3 && arrs[0] < arr[2] / 3 && arrs[1] < arr[3] / 3) {
						flag = true;
						drawBorder_2_getWidget(arrs,map[prop]["childMap"],deep+1);
					}
				}
				if(!flag){
					return {"deep":deep,"widget":map};
				}
			}

			//save&exit steps
			function saveSteps(){
				$.ajax({
					type:"post",
					url:staticPath + "/api/generate/"+caseId,
					success:function(data){
						alert(data);
					}
				})
				// alert("已存储");
			}
			function click4Step(action,info){
				var w = JSON.parse(widget_json);
				console.log(w);
				var bounds = w["bounds"].join(",");
				var testCaseStep = {
					"testcaseId" : caseId,
					"indeks" : step_list.length,
					"responseTime" : 5,
					"action" : action,
					"xpath" : w["widgetXpath"],
					"text" : w["text"],
					"resourceId" :　w["tesource_id"],
					"contentDesc" : w["content_desc"],
					"message" : info,
					"bindFunction":w["bindFunction"],
					"klass":w["klass"],
					"bounds":bounds
				};
				step_list.push(testCaseStep);
				$.ajax({
					type:"post",
					url:staticPath + "/step/addTestCaseSteps",
					data:{stepListStr:JSON.stringify([testCaseStep])},
					success:function(data){
						alert(data);
					}
				})
				console.log(step_list);
				$("#box_step").append('<li class="items" value="'+ (step_list.length-1) +'"><a href="javascript:void(0)" onclick="option.stepInfo()" class="a-block">'+action + " " + w["xPath"] +'</a><a href="javascript:void(0)" onclick="shouMenu(this)" class="a-block down_menu">+</a></li>');
			}

			var tipBox = document.getElementById("tipbox");

			function showTipBox(bounds) {
				var x = bounds[2];
				var y = (bounds[1] + bounds[3]) / 2;
				tipBox.setAttribute("style", "display:block;left:" + x / 3 + "px;top:" + (y / 3 - 45) + "px;");
				$("#tipbox").attr("data-x",x);
				$("#tipbox").attr("data-y",y);
			}

			function judgeChildMap(arrs, map) {
				var flag = true;
				for(var prop in map) {
					var arr = map[prop]["bounds"];
					if(arrs[0] >= arr[0] / 3 && arrs[1] >= arr[1] / 3 && arrs[0] < arr[2] / 3 && arrs[1] < arr[3] / 3) {
						flag = false;
						// console.log(flag);
						return flag;
					}
				}
				// console.log(flag);
				return flag;
			}

			var startX = 0;
			var startY = 0;
			var endX = 0;
			var endY = 0;
			var downFlag = false;
			var upFlag = false;
			$(function() {
				var top = $("#box_canvas").offset().top;
				var left = $("#box_canvas").offset().left;

				var timer = null;
				$("#myCanvas,#canvas").bind("dblclick", function(e) {
					timer = setTimeout(function() {
						e.preventDefault();
						console.log("dblclick");
						wss.send("d 0 " + (e.pageX - left) * 3 + " " + (e.pageY - top) * 3 + " 50\nc\nu 0\nc\n");
					}, 100);
					click4Step("tap", "");
				});

				$("#myCanvas,#canvas").bind("mousedown", function(e) {
					e.preventDefault();
					startX = e.pageX - left;
					startY = e.pageY - top;
					downFlag = true;
				});

				$("#myCanvas,#canvas").bind("mouseup", function(e) {
					e.preventDefault();
					endX = e.pageX - left;
					endY = e.pageY - top;
					upFlag = true;
				});

				$("#myCanvas,#canvas").bind("mousemove", function(e) {
					timer = setTimeout(function() {
						var X = endX - startX;
						var Y = endY - startY;
						if((upFlag == true && downFlag == true) && (Math.abs(X) > 100 || Math.abs(Y) > 100)) {
							console.log("d 0 " + startX * 3 + " " + startY * 3 + " 50\nc\nm 0 " + endX * 3 + " " + endY * 3 + " 50\nc\nu 0\nc\n");
							wss.send("d 0 " + startX * 3 + " " + startY * 3 + " 50\nc\nm 0 " + endX * 3 + " " + endY * 3 + " 50\nc\nu 0\nc\n");
							downFlag = false;
							upFlag = false;
						}
					}, 50);
					// click4Step("swipe",startX*3+","+startY*3+","+endX*3+endY*3);
				});

			});
			/*
				右键菜单：
				知识点：鼠标事件 mousedown mousemove mouseover mouseleave mouseup
				鼠标事件：绑定document
			*/
			var displayFlag = false;
			function shouMenu(obj,caseId,indeks,id) {
				//var top = $(this).parents("li")[0].offsetTop+parseInt($(this).parents("li").css("height"));
				var top1 = parseInt($(obj).parents("li").css("height"));
				var left1 = parseInt($(obj).parents("li").css("width"));
				var left2 = $(obj).parents("li")[0].offsetLeft;
				var top2 = $(obj).parents("li")[0].offsetTop;
				$(".contextMenu").css({
					"display": displayFlag?"none":"inline-block",
					"left": left1-left2,
					"top": top1+top2
				});
				displayFlag = !displayFlag;
				//
				$(".contextMenu").attr("data-caseid",caseId);
				$(".contextMenu").attr("data-indeks",indeks);
				$(".contextMenu").attr("data-id",id);
			}
			
			$(document).keydown(function(event){
				if(event.which == 16){
					$("#keymask").remove();
					$("body").append("<div id='keymask'></div>");
					$("#keymask").addClass("mask").fadeIn("slow");
					$("#dg_box_menu").fadeIn("slow");
				}
			});
			$(document).click(function(){
				$("#dg_box_menu").fadeOut("fast");
				$("#keymask").css({ display: 'none' });
			});
		</script>
	</body>
</html>